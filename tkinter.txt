import tkinter as tk
from tkinter import ttk, messagebox
import mysql.connector

class ShoppingApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Online Shopping App")
        self.root.geometry("800x600") 
        
        self.cart = {} 

        self.setup_database()
        
        self.create_widgets()
        
        self.show_products()

    def setup_database(self):
        try:
            conn = mysql.connector.connect(
                host="localhost",
                user="root",
                password="Cu@11028"
            )
            cursor = conn.cursor()
            
            cursor.execute("CREATE DATABASE IF NOT EXISTS online_shopping")
            cursor.execute("USE online_shopping")

            cursor.execute("""
            CREATE TABLE IF NOT EXISTS products (
                id INT AUTO_INCREMENT PRIMARY KEY,
                name VARCHAR(100) NOT NULL,
                price DECIMAL(10,2) NOT NULL
            )
            """)

            cursor.execute("""
            CREATE TABLE IF NOT EXISTS orders (
                order_id INT AUTO_INCREMENT PRIMARY KEY,
                product_name VARCHAR(100),
                quantity INT,
                total_price DECIMAL(10,2)
            )
            """)

            cursor.execute("SELECT COUNT(*) FROM products")
            if cursor.fetchone()[0] == 0:
                sample_products = [
                    ('Laptop', 50000),
                    ('Smartphone', 15000),
                    ('Headphones', 2000),
                    ('Smartwatch', 8000),
                    ('Keyboard', 1200)
                ]
                cursor.executemany(
                    "INSERT INTO products (name, price) VALUES (%s, %s)",
                    sample_products
                )
                conn.commit()

            cursor.close()
            conn.close()

        except mysql.connector.Error as err:
            messagebox.showerror("Database Error", f"Error during setup: {err}")
            self.root.quit()

    def get_connection(self):
        try:
            return mysql.connector.connect(
                host="localhost",
                user="root",
                password="Cu@11028",
                database="online_shopping"
            )
        except mysql.connector.Error as err:
            messagebox.showerror("Connection Error", f"Could not connect to database: {err}")
            return None

    def create_widgets(self):
        
        self.root.grid_rowconfigure(0, weight=1)
        self.root.grid_columnconfigure(0, weight=3)
        self.root.grid_columnconfigure(1, weight=2)

        products_frame = ttk.Frame(self.root, padding="10")
        products_frame.grid(row=0, column=0, sticky="nsew")
        products_frame.grid_rowconfigure(1, weight=1)
        products_frame.grid_columnconfigure(0, weight=1)

        search_bar_frame = ttk.Frame(products_frame)
        search_bar_frame.grid(row=0, column=0, sticky="ew", pady=5)
        ttk.Label(search_bar_frame, text="Search Product:").pack(side=tk.LEFT, padx=5)
        self.search_entry = ttk.Entry(search_bar_frame)
        self.search_entry.pack(side=tk.LEFT, fill="x", expand=True, padx=5)
        ttk.Button(search_bar_frame, text="Search", command=self.show_products).pack(side=tk.LEFT)

        cols = ('id', 'name', 'price')
        self.product_tree = ttk.Treeview(products_frame, columns=cols, show='headings', height=15)
        self.product_tree.grid(row=1, column=0, sticky="nsew")
        
        self.product_tree.heading('id', text='ID')
        self.product_tree.heading('name', text='Name')
        self.product_tree.heading('price', text='Price')
        
        self.product_tree.column('id', width=30, stretch=False)
        self.product_tree.column('name', width=200)
        self.product_tree.column('price', width=100, anchor='e')

        scrollbar = ttk.Scrollbar(products_frame, orient=tk.VERTICAL, command=self.product_tree.yview)
        self.product_tree.configure(yscroll=scrollbar.set)
        scrollbar.grid(row=1, column=1, sticky="ns")

        add_frame = ttk.Frame(products_frame)
        add_frame.grid(row=2, column=0, sticky="ew", pady=10)
        ttk.Label(add_frame, text="Quantity:").pack(side=tk.LEFT, padx=5)
        self.quantity_entry = ttk.Entry(add_frame, width=8)
        self.quantity_entry.pack(side=tk.LEFT, padx=5)
        ttk.Button(add_frame, text="Add to Cart", command=self.add_to_cart).pack(side=tk.LEFT, padx=5)

        cart_frame = ttk.Frame(self.root, padding="10", style="Card.TFrame")
        cart_frame.grid(row=0, column=1, sticky="nsew", padx=(0, 10))
        cart_frame.grid_rowconfigure(1, weight=1)
        cart_frame.grid_columnconfigure(0, weight=1)

        ttk.Label(cart_frame, text="Shopping Cart", font=("Helvetica", 16, "bold")).grid(row=0, column=0, columnspan=2, pady=5)
        
        cart_cols = ('product', 'qty', 'total')
        self.cart_tree = ttk.Treeview(cart_frame, columns=cart_cols, show='headings', height=12)
        self.cart_tree.grid(row=1, column=0, columnspan=2, sticky="nsew")
        
        self.cart_tree.heading('product', text='Product')
        self.cart_tree.heading('qty', text='Qty')
        self.cart_tree.heading('total', text='Total Price')
        self.cart_tree.column('product', width=150)
        self.cart_tree.column('qty', width=50, anchor='center')
        self.cart_tree.column('total', width=80, anchor='e')

        self.total_label = ttk.Label(cart_frame, text="Total: $0.00", font=("Helvetica", 12, "bold"))
        self.total_label.grid(row=2, column=0, columnspan=2, sticky="e", pady=10, padx=10)

        ttk.Button(cart_frame, text="Remove Selected", command=self.remove_from_cart).grid(row=3, column=0, sticky="w", pady=5)
        ttk.Button(cart_frame, text="Checkout", command=self.checkout).grid(row=3, column=1, sticky="e", pady=5)

    def fetch_products(self, search_text=""):
        conn = self.get_connection()
        if not conn:
            return []
            
        cursor = conn.cursor()
        if search_text:
            query = "SELECT id, name, price FROM products WHERE name LIKE %s"
            cursor.execute(query, ('%'+search_text+'%',))
        else:
            query = "SELECT id, name, price FROM products"
            cursor.execute(query)
        rows = cursor.fetchall()
        conn.close()
        return rows

    def show_products(self):
        for item in self.product_tree.get_children():
            self.product_tree.delete(item)
            
        for product in self.fetch_products(self.search_entry.get()):
            product_with_formatted_price = (
                product[0], 
                product[1], 
                f"${product[2]:.2f}"
            )
            self.product_tree.insert("", tk.END, values=product_with_formatted_price)

    def add_to_cart(self):
        selection = self.product_tree.focus()
        if not selection:
            messagebox.showwarning("Warning", "Select a product first")
            return

        try:
            qty = int(self.quantity_entry.get())
            if qty <= 0:
                raise ValueError
        except ValueError:
            messagebox.showwarning("Invalid Quantity", "Enter a valid positive quantity")
            self.quantity_entry.delete(0, tk.END)
            return

        item_data = self.product_tree.item(selection)['values']
        product_id = item_data[0]
        product_name = item_data[1]
        price = float(item_data[2].replace("$", ""))

        if product_name in self.cart:
            self.cart[product_name]['qty'] += qty
        else:
            self.cart[product_name] = {'id': product_id, 'price': price, 'qty': qty}

        self.update_cart_display()
        self.quantity_entry.delete(0, tk.END)

    def remove_from_cart(self):
        selection = self.cart_tree.focus()
        if not selection:
            messagebox.showwarning("Warning", "Select an item from the cart to remove")
            return
        
        product_name = self.cart_tree.item(selection)['values'][0]
        
        if product_name in self.cart:
            del self.cart[product_name]
            
        self.update_cart_display()

    def update_cart_display(self):
        for item in self.cart_tree.get_children():
            self.cart_tree.delete(item)
            
        grand_total = 0
        
        for product_name, data in self.cart.items():
            total_price = data['price'] * data['qty']
            grand_total += total_price
            
            display_values = (product_name, data['qty'], f"${total_price:.2f}")
            self.cart_tree.insert("", tk.END, values=display_values)
            
        self.total_label.config(text=f"Total: ${grand_total:.2f}")

    def checkout(self):
        if not self.cart:
            messagebox.showinfo("Cart Empty", "No products in cart to checkout")
            return

        conn = self.get_connection()
        if not conn:
            return
            
        cursor = conn.cursor()
        
        try:
            total_amount = 0
            for product_name, data in self.cart.items():
                qty = data['qty']
                total_price = data['price'] * qty
                total_amount += total_price
                
                cursor.execute(
                    "INSERT INTO orders (product_name, quantity, total_price) VALUES (%s, %s, %s)",
                    (product_name, qty, total_price)
                )
            
            conn.commit()
            
            messagebox.showinfo("Checkout", f"Total amount: ${total_amount:.2f}\nOrder saved to database!")
            
            self.cart.clear()
            self.update_cart_display()

        except mysql.connector.Error as err:
            messagebox.showerror("Database Error", f"Could not save order: {err}")
            conn.rollback()
        finally:
            conn.close()


if __name__ == "__main__":
    root = tk.Tk()
    
    style = ttk.Style(root)
    style.configure("Card.TFrame", background="#f0f0f0", relief="groove", borderwidth=2)
    
    app = ShoppingApp(root)
    root.mainloop()